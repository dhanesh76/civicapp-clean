<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS/STOMP Test Client</title>
  <style>
    body{font-family:Segoe UI,Roboto,Arial;max-width:900px;margin:18px auto;color:#111}
    header{display:flex;justify-content:space-between;align-items:center}
    .card{border:1px solid #ddd;padding:12px;border-radius:6px;margin:12px 0}
    input,select,button{padding:8px;margin:6px 0;width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    pre{background:#111;color:#bde; padding:12px; border-radius:6px; max-height:300px; overflow:auto}
    label{font-weight:600}
  </style>
  <!-- CDN: SockJS and STOMP (simple, works in browser) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <header>
    <h2>WebSocket / STOMP Tester</h2>
    <small>Connects to <code>/ws</code> & REST on <code>http://localhost:8080</code></small>
  </header>

  <div class="card">
    <label>Auth (login)</label>
    <input id="loginId" placeholder="mobile or email (loginId)" value="" />
    <input id="password" placeholder="password" type="password" value="" />
    <div class="row">
      <button id="btnLogin">Login</button>
      <button id="btnLogout" disabled>Logout</button>
    </div>
    <div>
      <small>Access token:</small>
      <pre id="accessToken">(not logged in)</pre>
      <small>User id (db `Users.id`): <span id="userId">-</span></small>
    </div>
  </div>

  <div class="card">
    <label>WebSocket Connect</label>
    <input id="wsUrl" value="http://localhost:8080/ws" />
    <div class="row">
      <button id="btnConnect" disabled>Connect STOMP</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
    </div>
    <div>
      <small>Connection status: <strong id="connStatus">disconnected</strong></small>
    </div>
  </div>

  <div class="card">
    <label>Subscribe to Topic</label>
    <select id="topicType">
      <option value="user">user</option>
      <option value="worker">worker</option>
      <option value="department">department</option>
    </select>
    <input id="topicId" placeholder="id (Users.id or department id)" />
    <div class="row">
      <button id="btnSubscribe" disabled>Subscribe</button>
      <button id="btnUnsubscribe" disabled>Unsubscribe</button>
    </div>
    <div>
      <small>Subscribed destinations:</small>
      <pre id="subs">(none)</pre>
    </div>
  </div>

  <div class="card">
    <label>Trigger notification via REST</label>
    <input id="triggerComplaintId" placeholder="complaintId (e.g., C09H2)" />
    <input id="triggerWorkerId" placeholder="workerId (Staff.user.id)" />
    <div class="row">
      <button id="btnTrigger">Trigger /api/departments/complaints/assign</button>
      <button id="btnTriggerApprove">Trigger Approve (approve/{complaintId})</button>
    </div>
    <div>
      <small>REST response:</small>
      <pre id="restResult">(no action)</pre>
    </div>
  </div>

  <div class="card">
    <label>Messages</label>
    <pre id="messages">(no messages yet)</pre>
  </div>

<script>
// Globals
let stompClient = null;
let accessToken = null;
let currentSubs = {};
let userId = null;

function appendMsg(msg){
  const el = document.getElementById('messages');
  el.textContent = (new Date()).toISOString() + '  ' + msg + '\n' + el.textContent;
}

async function login(){
  const loginId = document.getElementById('loginId').value.trim();
  const password = document.getElementById('password').value;
  if(!loginId || !password){ alert('enter loginId and password'); return; }

  const res = await fetch('http://localhost:8080/api/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({loginId,password}) });
  if(!res.ok){ const t = await res.text(); document.getElementById('accessToken').textContent = 'LOGIN FAILED: ' + t; return; }
  const body = await res.json();
  accessToken = body.accessToken;
  userId = body.userId;
  document.getElementById('accessToken').textContent = accessToken;
  document.getElementById('userId').textContent = userId;
  document.getElementById('btnConnect').disabled = false;
  document.getElementById('btnLogout').disabled = false;
  appendMsg('Logged in as ' + body.loginId + ' userId=' + userId);
}

function logout(){
  accessToken = null;
  userId = null;
  document.getElementById('accessToken').textContent = '(not logged in)';
  document.getElementById('userId').textContent = '-';
  document.getElementById('btnConnect').disabled = true;
  document.getElementById('btnLogout').disabled = true;
  appendMsg('Logged out');
}

function connectStomp(){
  if(!accessToken){ alert('Login first'); return; }
  const url = document.getElementById('wsUrl').value || 'http://localhost:8080/ws';
  const sock = new SockJS(url);
  stompClient = Stomp.over(sock);
  stompClient.debug = function(){ /* silence */ };
  const headers = { Authorization: 'Bearer ' + accessToken };
  stompClient.connect(headers, function(frame){
    document.getElementById('connStatus').textContent = 'connected';
    document.getElementById('btnDisconnect').disabled = false;
    document.getElementById('btnConnect').disabled = true;
    document.getElementById('btnSubscribe').disabled = false;
    appendMsg('STOMP CONNECTED: ' + frame);
  }, function(err){
    appendMsg('STOMP ERROR: ' + JSON.stringify(err));
  });
}

function disconnectStomp(){
  if(stompClient){
    stompClient.disconnect(() => {
      document.getElementById('connStatus').textContent = 'disconnected';
      document.getElementById('btnDisconnect').disabled = true;
      document.getElementById('btnConnect').disabled = false;
      document.getElementById('btnSubscribe').disabled = true;
      appendMsg('STOMP disconnected');
    });
    stompClient = null;
    // clear subs
    currentSubs = {};
    document.getElementById('subs').textContent = '(none)';
  }
}

function subscribeTopic(){
  if(!stompClient || !stompClient.connected){ alert('Connect first'); return; }
  const type = document.getElementById('topicType').value;
  const id = document.getElementById('topicId').value.trim() || userId;
  if(!id){ alert('Provide topic id or login first'); return; }
  const dest = '/topic/' + type + '/' + id;
  if(currentSubs[dest]){ alert('Already subscribed to ' + dest); return; }
  const sub = stompClient.subscribe(dest, function(message){
    appendMsg('RECV from ' + dest + ' -> ' + message.body);
  });
  currentSubs[dest] = sub;
  updateSubsDisplay();
  appendMsg('Subscribed to ' + dest);
  document.getElementById('btnUnsubscribe').disabled = false;
}

function unsubscribeTopic(){
  const type = document.getElementById('topicType').value;
  const id = document.getElementById('topicId').value.trim() || userId;
  const dest = '/topic/' + type + '/' + id;
  const sub = currentSubs[dest];
  if(!sub){ alert('No subscription for ' + dest); return; }
  sub.unsubscribe();
  delete currentSubs[dest];
  updateSubsDisplay();
  appendMsg('Unsubscribed ' + dest);
}

function updateSubsDisplay(){
  const keys = Object.keys(currentSubs);
  document.getElementById('subs').textContent = keys.length ? keys.join('\n') : '(none)';
}

async function triggerAssign(){
  if(!accessToken){ alert('Login first'); return; }
  const complaintId = document.getElementById('triggerComplaintId').value.trim();
  const workerId = Number(document.getElementById('triggerWorkerId').value.trim());
  if(!complaintId || !workerId){ alert('Enter complaintId and workerId'); return; }
  const res = await fetch('http://localhost:8080/api/departments/complaints/assign',{
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + accessToken },
    body: JSON.stringify({ complaintId, workerId })
  });
  const txt = await res.text();
  document.getElementById('restResult').textContent = res.status + ' - ' + txt;
  appendMsg('Triggered assign for ' + complaintId + ' -> ' + workerId + ' (status ' + res.status + ')');
}

async function triggerApprove(){
  if(!accessToken){ alert('Login first'); return; }
  const complaintId = document.getElementById('triggerComplaintId').value.trim();
  if(!complaintId){ alert('Enter complaintId'); return; }
  const res = await fetch('http://localhost:8080/api/departments/complaints/approve/' + encodeURIComponent(complaintId),{
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + accessToken }
  });
  const txt = await res.text();
  document.getElementById('restResult').textContent = res.status + ' - ' + txt;
  appendMsg('Triggered approve for ' + complaintId + ' (status ' + res.status + ')');
}

// Wire up UI
document.getElementById('btnLogin').addEventListener('click', login);
document.getElementById('btnLogout').addEventListener('click', logout);
document.getElementById('btnConnect').addEventListener('click', connectStomp);
document.getElementById('btnDisconnect').addEventListener('click', disconnectStomp);
document.getElementById('btnSubscribe').addEventListener('click', subscribeTopic);
document.getElementById('btnUnsubscribe').addEventListener('click', unsubscribeTopic);
document.getElementById('btnTrigger').addEventListener('click', triggerAssign);
document.getElementById('btnTriggerApprove').addEventListener('click', triggerApprove);

// Enable quick connect if login exists in local storage
(function(){
  // no-op for now
})();
</script>
</body>
</html>
